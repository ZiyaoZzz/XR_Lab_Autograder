<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade Statistics Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .stats-section {
            margin-bottom: 30px;
        }
        .chart-container {
            margin: 20px 0;
            height: 400px;
        }
        .file-input {
            margin: 20px 0;
            padding: 20px;
            border: 2px dashed #ccc;
            border-radius: 4px;
            text-align: center;
        }
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .summary-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }
        .ranking-section {
            margin-top: 30px;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .ranking-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .ranking-table th,
        .ranking-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .ranking-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .ranking-table tr:hover {
            background-color: #f5f5f5;
        }
        .distribution-controls {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .distribution-controls select {
            margin-left: 10px;
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .criterion-distributions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-top: 20px;
            padding: 15px;
        }
        .criterion-chart-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            height: 350px;
            transition: all 0.3s ease;
        }
        .criterion-chart-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
        }
        .stats-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .stats-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .stats-details {
            font-size: 0.95em;
            line-height: 1.5;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Grade Statistics Analysis</h1>
        
        <div class="file-input">
            <input type="file" id="csvFile" accept=".csv">
            <p>Please select a grade CSV file</p>
        </div>

        <div class="stats-section">
            <h2>Overall Grade Distribution</h2>
            <div class="distribution-controls">
                <label>Distribution Type:</label>
                <select id="distributionType">
                    <option value="fixed">Fixed Ranges (0-100)</option>
                    <option value="dynamic">Dynamic Ranges</option>
                </select>
            </div>
            <div class="chart-container">
                <canvas id="gradeDistribution"></canvas>
            </div>
        </div>

        <div class="stats-section">
            <h2>Criterion Distribution</h2>
            <div class="chart-container">
                <canvas id="criterionDistribution"></canvas>
            </div>
        </div>

        <div class="summary">
            <div class="summary-card">
                <h3>Average</h3>
                <p id="averageGrade">-</p>
            </div>
            <div class="summary-card">
                <h3>Maximum</h3>
                <p id="maxGrade">-</p>
            </div>
            <div class="summary-card">
                <h3>Minimum</h3>
                <p id="minGrade">-</p>
            </div>
            <div class="summary-card">
                <h3>Median</h3>
                <p id="medianGrade">-</p>
            </div>
        </div>

        <h2>Individual Criterion Distributions (Rank the variance from top to bottom)</h2>
        <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #2196f3;">
            <p style="margin: 0; color: #333; line-height: 1.6;">
                <strong>Variance Threshold Calculation:</strong> The threshold for identifying high-variance criteria is calculated dynamically using statistical methods. We first calculate the mean (μ) and standard deviation (σ) of all criterion variances. The threshold is then set at μ + σ, meaning any criterion with variance above this threshold (approximately the top 16% based on normal distribution) is flagged for review. This adaptive approach ensures the threshold adjusts automatically to the overall grade distribution pattern.
            </p>
        </div>
        <div id="criterionDistributions" class="criterion-distributions"></div>
        
        <div class="ranking-section">
            <h2>Student Rankings</h2>
            <div id="rankingTable"></div>
        </div>
    </div>

    <script>
        // Load test.csv file by default when page loads
        window.addEventListener('load', function() {
            fetch('test.csv')
                .then(response => response.text())
                .then(data => {
                    processGrades(data);
                })
                .catch(error => {
                    console.error('Error loading test.csv:', error);
                });
        });

        // Keep the file input handler for optional file uploads
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function(event) {
                const csvData = event.target.result;
                processGrades(csvData);
            };
            
            reader.readAsText(file);
        });

        function processGrades(csvData) {
            const rows = csvData.split('\n');
            const headers = rows[0].split(',');
            
            // Get column indices from headers
            const columnIndices = {
                criterion: headers.indexOf('Criterion'),
                score: headers.indexOf('Score'),
                max: headers.indexOf('Max'),
                file: headers.indexOf('File'),
                architect: headers.indexOf('Architect')
            };

            const data = rows.slice(1)
                .map(row => row.split(','))
                .filter(row => row.length > 1);

            // Process criterion scores and student data
            const criterionScores = {};
            const studentScores = {};

            data.forEach(row => {
                const criterion = row[columnIndices.criterion];
                const score = parseFloat(row[columnIndices.score]);
                const fileName = row[columnIndices.file];
                const studentName = fileName.split('_')[0];

                // Process criterion scores
                if (!criterionScores[criterion] && !isNaN(score)) {
                    criterionScores[criterion] = {
                        name: criterion,
                        scores: [],
                        maxScore: 0
                    };
                }
                if (criterionScores[criterion] && !isNaN(score)) {
                    criterionScores[criterion].scores.push(score);
                    criterionScores[criterion].maxScore = Math.max(criterionScores[criterion].maxScore, score);
                }

                // Process student total scores
                if (!studentScores[studentName]) {
                    studentScores[studentName] = 0;
                }
                if (!isNaN(score)) {
                    studentScores[studentName] += score;
                }
            });

            // Create individual criterion distribution charts
            const criterionContainer = document.getElementById('criterionDistributions');
            criterionContainer.innerHTML = ''; // Clear existing charts

            // Calculate variances and create sorted array of criteria
            const criterionVariances = Object.entries(criterionScores).map(([criterion, data]) => {
                const scores = data.scores;
                const mean = scores.reduce((a, b) => a + b, 0) / scores.length;
                const variance = scores.reduce((acc, score) => acc + Math.pow(score - mean, 2), 0) / scores.length;
                const stdDev = Math.sqrt(variance);

                return {
                    criterion,
                    data,
                    variance,
                    mean,
                    stdDev
                };
            });

            // Calculate variance statistics for threshold determination
            const varianceValues = criterionVariances.map(c => c.variance);
            const varianceMean = varianceValues.reduce((a, b) => a + b, 0) / varianceValues.length;
            const varianceStdDev = Math.sqrt(
                varianceValues.reduce((acc, val) => acc + Math.pow(val - varianceMean, 2), 0) / varianceValues.length
            );

            // Set threshold using mean + 1 standard deviation
            const varianceThreshold = varianceMean + varianceStdDev;

            // Sort and add needsCurving flag based on calculated threshold
            criterionVariances.sort((a, b) => b.variance - a.variance)
                .forEach(criterion => {
                    criterion.needsCurving = criterion.variance > varianceThreshold;
                });

            criterionVariances.forEach(({criterion, data, variance, mean, stdDev, needsCurving}) => {
                // Create container for this criterion's chart
                const chartDiv = document.createElement('div');
                chartDiv.className = 'criterion-chart-container';
                
                // Add statistics summary with dynamic threshold information
                const statsDiv = document.createElement('div');
                statsDiv.style.marginBottom = '10px';
                statsDiv.innerHTML = `
                    <div style="color: ${needsCurving ? '#d32f2f' : '#2e7d32'}; font-weight: bold; margin-bottom: 5px;">
                        ${needsCurving ? `⚠️ High variance detected (> ${varianceThreshold.toFixed(3)})` : '✓ Variance within acceptable range'}
                    </div>
                    <div style="font-size: 0.9em; color: #666;">
                        Mean: ${mean.toFixed(2)} | 
                        Std Dev: ${stdDev.toFixed(2)} | 
                        Variance: ${variance.toFixed(3)} |
                        Threshold: ${varianceThreshold.toFixed(3)}
                    </div>
                `;
                chartDiv.appendChild(statsDiv);

                const canvas = document.createElement('canvas');
                chartDiv.appendChild(canvas);
                criterionContainer.appendChild(chartDiv);

                // Calculate distribution for this criterion
                const scores = data.scores;
                const maxScore = 5;
                const ranges = [0, 1, 2, 3, 4, 5];
                const distribution = new Array(ranges.length - 1).fill(0);

                scores.forEach(score => {
                    if (score === 5) {
                        distribution[4]++; // Put score of 5 in the last bin (4-5)
                    } else {
                        const binIndex = Math.floor(score);
                        if (binIndex >= 0 && binIndex < distribution.length) {
                            distribution[binIndex]++;
                        }
                    }
                });

                // Create the chart with modified options
                new Chart(canvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['0-1', '1-2', '2-3', '3-4', '4-5'],
                        datasets: [{
                            label: 'Number of Students',
                            data: distribution,
                            backgroundColor: needsCurving ? 
                                'rgba(211, 47, 47, 0.5)' : 'rgba(75, 192, 192, 0.5)',
                            borderColor: needsCurving ? 
                                'rgba(211, 47, 47, 1)' : 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: `Distribution for ${criterion}`
                            }
                        }
                    }
                });
            });

            // Calculate criterion distribution using criterion names
            const criterionLabels = Object.values(criterionScores)
                .map(criterion => criterion.name)
                .filter(name => name !== "undefined" && name !== "");
            
            const criterionData = Object.values(criterionScores).map(criterion => {
                const scores = criterion.scores;
                return scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;
            });

            // Use actual max scores for each criterion
            const maxScores = Object.values(criterionScores).map(criterion => criterion.maxScore);

            // Draw criterion distribution chart
            const ctxCriterion = document.getElementById('criterionDistribution').getContext('2d');
            if (window.criterionChart) {
                window.criterionChart.destroy();
            }
            window.criterionChart = new Chart(ctxCriterion, {
                type: 'bar',
                data: {
                    labels: criterionLabels,
                    datasets: [{
                        label: 'Average Score',
                        data: criterionData,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        barPercentage: 0.8
                    }, {
                        label: 'Maximum Score',
                        data: maxScores,
                        backgroundColor: 'rgba(255, 99, 132, 0.5)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 2,
                        type: 'line'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 5.5,
                            title: {
                                display: true,
                                text: 'Score'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Criteria'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Criterion Score Distribution'
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });

            // Calculate overall statistics using student total scores
            const totalGrades = Object.values(studentScores);
            const average = totalGrades.reduce((a, b) => a + b, 0) / totalGrades.length;
            const max = Math.max(...totalGrades);
            const min = Math.min(...totalGrades);
            const sortedGrades = [...totalGrades].sort((a, b) => a - b);
            const median = sortedGrades[Math.floor(sortedGrades.length / 2)];

            // Update summary cards
            document.getElementById('averageGrade').textContent = average.toFixed(2);
            document.getElementById('maxGrade').textContent = max.toFixed(2);
            document.getElementById('minGrade').textContent = min.toFixed(2);
            document.getElementById('medianGrade').textContent = median.toFixed(2);

            // Create grade distribution histogram
            const gradeRanges = [0, 60, 70, 80, 90, 100];
            const distribution = new Array(gradeRanges.length - 1).fill(0);
            
            // Calculate max possible score based on number of criteria
            const numberOfCriteria = Object.keys(criterionScores).length;
            const maxPossibleScore = numberOfCriteria * 5; // Each criterion has max score of 5
            
            function updateGradeDistribution(type) {
                const ctx = document.getElementById('gradeDistribution').getContext('2d');
                let ranges, labels, distributionData;
                
                if (type === 'fixed') {
                    ranges = [0, 60, 70, 80, 90, 100];
                    labels = ['0-59', '60-69', '70-79', '80-89', '90-100'];
                    distributionData = new Array(ranges.length - 1).fill(0);
                    
                    totalGrades.forEach(grade => {
                        const percentage = (grade / maxPossibleScore) * 100;
                        for (let i = 0; i < ranges.length - 1; i++) {
                            if (percentage >= ranges[i] && percentage <= ranges[i + 1]) {
                                distributionData[i]++;
                                break;
                            }
                        }
                    });
                } else {
                    // Dynamic ranges based on actual scores
                    const minGrade = Math.min(...totalGrades);
                    const maxGrade = Math.max(...totalGrades);
                    const range = maxGrade - minGrade;
                    const binSize = range / 5; // Split into 5 equal bins
                    
                    ranges = Array.from({length: 6}, (_, i) => minGrade + (binSize * i));
                    labels = ranges.slice(0, -1).map((val, i) => 
                        `${val.toFixed(1)}-${ranges[i + 1].toFixed(1)}`
                    );
                    
                    distributionData = new Array(5).fill(0);
                    totalGrades.forEach(grade => {
                        for (let i = 0; i < ranges.length - 1; i++) {
                            if (grade >= ranges[i] && grade < ranges[i + 1]) {
                                distributionData[i]++;
                                break;
                            }
                        }
                    });
                }

                // Update the chart
                if (window.gradeChart) {
                    window.gradeChart.destroy();
                }
                window.gradeChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Number of Students',
                            data: distributionData,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Grade Distribution'
                            }
                        }
                    }
                });
            }

            // Add event listener for distribution type change
            document.getElementById('distributionType').addEventListener('change', function(e) {
                updateGradeDistribution(e.target.value);
            });

            // Initial distribution update
            updateGradeDistribution('fixed');

            // Add ranking table generation with dynamic max score
            const studentRankings = Object.entries(studentScores)
                .map(([name, score]) => ({ 
                    name, 
                    score,
                    percentage: (score / maxPossibleScore) * 100
                }))
                .sort((a, b) => b.score - a.score);

            // Generate ranking table HTML
            const rankingTableHTML = `
                <table class="ranking-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Student</th>
                            <th>Total Score</th>
                            <th>Percentage</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${studentRankings.map((student, index) => `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${student.name}</td>
                                <td>${student.score.toFixed(2)} / ${maxPossibleScore}</td>
                                <td>${student.percentage.toFixed(2)}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            // Update ranking table
            document.getElementById('rankingTable').innerHTML = rankingTableHTML;
        }
    </script>
</body>
</html>
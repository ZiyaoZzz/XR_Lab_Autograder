<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>File Size Reducer Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 30px; background: #f8f8f8; }
        h1 { color: #1976d2; }
        .file-input { margin-bottom: 20px; }
        .progress-bar {
            width: 100%;
            background: #e0e0e0;
            border-radius: 8px;
            margin: 20px 0 10px 0;
            height: 28px;
            overflow: hidden;
        }
        .progress-bar-inner {
            height: 100%;
            background: #2196f3;
            color: #fff;
            text-align: center;
            line-height: 28px;
            font-weight: bold;
            transition: width 0.3s;
        }
        table { border-collapse: collapse; width: 100%; background: #fff; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background: #e3f2fd; }
        tr.reduced { background: #e8f5e9; }
        tr.failed { background: #ffe0e0; }
        .summary { margin: 20px 0; }
        .output-path { color: #1976d2; font-weight: bold; }
    </style>
</head>
<body>
    <h1>File Size Reducer Dashboard</h1>
    <div class="file-input">
        <input type="file" id="fileInput" multiple>
        <span>Select files to process (PDF, CSV, etc.)</span>
    </div>
    <div class="progress-bar">
        <div class="progress-bar-inner" id="progressBar" style="width:0%">0%</div>
    </div>
    <button id="showResultBtn" style="margin:20px 0; padding:10px 20px; font-size:1.1em;">Show Latest Results</button>
    <div class="summary" id="summary"></div>
    <div class="download-buttons" style="margin: 20px 0; display: flex; gap: 10px;">
        <a href="http://127.0.0.1:5000/result.csv" id="downloadMetadataBtn" 
           style="background-color: #4CAF50; color: white; padding: 10px 15px; text-decoration: none; border-radius: 4px; font-weight: bold;">
           Download Metadata CSV
        </a>
        <a href="http://127.0.0.1:5000/reduced_pdfs.zip" id="downloadZipBtn"
           style="background-color: #2196F3; color: white; padding: 10px 15px; text-decoration: none; border-radius: 4px; font-weight: bold;">
           Download All Reduced PDFs (ZIP)
        </a>
    </div>
    <div id="resultTable"></div>
    <script>
        let filesToProcess = [];
        let results = [];
        let processedCount = 0;
        let reducedCount = 0;
        let failedCount = 0;
        let totalOriginalSize = 0;
        let totalReducedSize = 0;

        document.getElementById('fileInput').addEventListener('change', function(e) {
            filesToProcess = Array.from(e.target.files);
            results = [];
            processedCount = 0;
            reducedCount = 0;
            failedCount = 0;
            totalOriginalSize = 0;
            totalReducedSize = 0;
            updateProgress();
            document.getElementById('resultTable').innerHTML = '';
            document.getElementById('summary').innerHTML = '';
            if (filesToProcess.length > 0) {
                processNextFile();
            }
        });

        function processNextFile() {
            if (processedCount >= filesToProcess.length) {
                showSummary();
                return;
            }
            const file = filesToProcess[processedCount];
            // Simulate processing (replace with real logic as needed)
            setTimeout(() => {
                const originalSize = file.size;
                // Simulate reduction: 80% chance to reduce, 20% fail
                let reduced = Math.random() < 0.8;
                let reducedSize = reduced ? Math.floor(originalSize * (0.5 + 0.4 * Math.random())) : originalSize;
                let outputPath = reduced ? `reduced/${file.name}` : '-';
                let status = reduced ? 'Reduced' : 'Failed';
                if (reduced) {
                    reducedCount++;
                    totalReducedSize += reducedSize;
                } else {
                    failedCount++;
                    totalReducedSize += originalSize;
                }
                totalOriginalSize += originalSize;
                results.push({
                    name: file.name,
                    originalSize,
                    reducedSize,
                    outputPath,
                    status
                });
                processedCount++;
                updateProgress();
                renderTable();
                if (processedCount < filesToProcess.length) {
                    processNextFile();
                } else {
                    showSummary();
                }
            }, 400 + Math.random() * 400); // Simulate processing time
        }

        function updateProgress() {
            const percent = filesToProcess.length === 0 ? 0 : Math.round((processedCount / filesToProcess.length) * 100);
            const bar = document.getElementById('progressBar');
            bar.style.width = percent + '%';
            bar.textContent = percent + '%';
        }

        function renderTable() {
            if (results.length === 0) return;
            let html = '<table><thead><tr>' +
                '<th>File Name</th><th>Original Size (KB)</th><th>Reduced Size (KB)</th><th>Status</th><th>Output Path</th></tr></thead><tbody>';
            results.forEach(r => {
                const rowClass = r.status === 'Reduced' ? 'reduced' : (r.status === 'Failed' ? 'failed' : '');
                html += `<tr class="${rowClass}">` +
                    `<td>${r.name}</td>` +
                    `<td>${(r.originalSize/1024).toFixed(1)}</td>` +
                    `<td>${(r.reducedSize/1024).toFixed(1)}</td>` +
                    `<td>${r.status}</td>` +
                    `<td class="output-path">${r.outputPath}</td>` +
                    '</tr>';
            });
            html += '</tbody></table>';
            document.getElementById('resultTable').innerHTML = html;
        }

        function showSummary() {
            let percentReduced = reducedCount === 0 ? 0 : Math.round(100 * (totalOriginalSize - totalReducedSize) / totalOriginalSize);
            document.getElementById('summary').innerHTML =
                `<b>Total files:</b> ${filesToProcess.length} &nbsp; | &nbsp; ` +
                `<b>Reduced:</b> <span style="color:green">${reducedCount}</span> &nbsp; | &nbsp; ` +
                `<b>Failed:</b> <span style="color:red">${failedCount}</span> &nbsp; | &nbsp; ` +
                `<b>Total original size:</b> ${(totalOriginalSize/1024).toFixed(1)} KB &nbsp; | &nbsp; ` +
                `<b>Total reduced size:</b> ${(totalReducedSize/1024).toFixed(1)} KB &nbsp; | &nbsp; ` +
                `<b>Space saved:</b> <span style="color:blue">${percentReduced}%</span>`;
        }

        const formData = new FormData();
        for (const file of filesToProcess) {
            formData.append('files', file);
        }
        fetch('http://localhost:5000/upload', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.conversion_done) {
                document.getElementById('summary').innerHTML = 
                    `<span style="color:green;">DOCX to PDF conversion complete!</span><br>` +
                    (data.converted_pdfs.length ? `Converted: ${data.converted_pdfs.join(', ')}` : '') +
                    document.getElementById('summary').innerHTML;
            }
            // 1. Show the download link for the CSV
            document.getElementById('summary').innerHTML = `
                <a href="http://localhost:5000${data.result_csv}" target="_blank" style="font-weight:bold;color:#1976d2;">
                    Download result.csv
                </a>
                <br>
                <b>Total files:</b> ${data.results.length}
            `;

            // 2. Render the metadata table
            if (data.results && data.results.length) {
                let html = '<table><thead><tr>';
                Object.keys(data.results[0]).forEach(h => html += `<th>${h}</th>`);
                html += '</tr></thead><tbody>';
                data.results.forEach(row => {
                    html += '<tr>';
                    Object.keys(row).forEach(h => html += `<td>${row[h]}</td>`);
                    html += '</tr>';
                });
                html += '</tbody></table>';
                document.getElementById('resultTable').innerHTML = html;
            }
        });
    </script>
</body>
</html> 